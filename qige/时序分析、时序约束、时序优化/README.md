# 时序分析（最重要）、时序约束、时序优化

### 1. 时序分析第一课：心中有电路，逻辑级数

1. 什么是时序？

   - 时序指的是寄存器的建立时间和保持时间。
   - 组合逻辑：没有时钟控制的数字电路。判断逻辑都是组合逻辑（三目运算符、case、if等，底层都是LUT实现的）。

   - 时序逻辑：有时钟控制的数字电路，有保存功能。有时钟控制的寄存器。
   - 逻辑级数

   - 建立时间：时钟上升沿之前数据保持稳定的时间。
   - 保持时间：时钟上升沿之后数据保持稳定的时间。
     - 建立时间和保持时间像一个窗口一样，窗口外的输入数据随便变化，窗口内的数据不可变化。

2. 为什么考虑时序？

   1. 满足寄存器的建立时间和保持时间才能使数据输出稳定，才可以保证我们的电路稳定

3. 什么是时序约束？

   1. 将时序分析中位置的参数指定一个数值，将信号的时序限定到一个准确的数值上
   2. 衍生时钟：由一个原始时钟分频或倍频出来的，也需要进行时钟约束；锁相环在生成时会自动约束输入时钟和输出时钟；

4. 为什么要时序约束？

   1. 

5. 时序分析模型
   1. 寄存器到寄存器模型
   2. 输入引脚到寄存器模型
   3. 寄存器到输出引脚模型
   4. 输入引脚到输出引脚模型

---

Tsu裕量 = （Tskew + Tcycle - Tsu）- (Tco + Tdelay) > 0

建立时间裕量 = 要求到达时间 - 实际到达时间

Thd裕量 = Tco - Thd > 0



建立时间裕量、组合逻辑延时决定时钟的最高频率；保持时间裕量与时钟的最高频率无关

赛灵思7系FPGA，一级逻辑级数延时约为0.4ns，最高时钟频率：假设200Mhz，时钟周期为5ns，5/0.4~=12级，还要考虑始终偏斜、建立时间、保持时间、Tco，最后大概跑8、9级。5级流水延时为5*0.4 = 2ns，则最快时钟周期可以跑到3ns



---

大部分约束IP核都做好了，只需要做一些主时钟约束、衍生时钟约束，或者一些异步的信号约束

比如说PLL对主时钟的约束

```verilog
create_clock -period 20.000 [get_ports clk_in1]
set_input_jitter [get_clocks -of_objects [get_ports clk_in1]] 0.04
//Tcl 语句
```



---

时序约束要在布局布线之后（Implementation），因为在综合阶段只是将代码翻译成电路，没有实际布局，无法得知线延时

1. 约束主时钟

2. 约束衍生时钟

3. 约束虚拟时钟

4. 约束input delay（输入引脚到寄存器）

5. 约束output delay（寄存器到外设引脚）

6. 约束异步时钟组（跨时钟域处理时；[异步时钟组约束是一种时序约束，用于处理异步时钟之间的时序关系。异步时钟是指两个时钟间相位不固定的时钟。在异步时钟组约束中，可以将不同的主时钟及其衍生时钟约束成不同的时钟组。由于异步时钟间相位不固定，时序分析的结果不确切，因此这部分的分析可以通过设置时钟组约束忽略，但是这并不意味着这部分的设计能工作正常。](https://www.bing.com/ck/a?!&&p=8d506729f96eb62fJmltdHM9MTcxODQwOTYwMCZpZ3VpZD0zNjQ5ODQ3My0yNzY5LTZmODItMjkzYy05NmQ4MjYyYTZlMGYmaW5zaWQ9NTcwOQ&ptn=3&ver=2&hsh=3&fclid=36498473-2769-6f82-293c-96d8262a6e0f&psq=约束异步时钟组&u=a1aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JlYm9ybl9MZWUvYXJ0aWNsZS9kZXRhaWxzLzg1MzA0MjM0&ntb=1)）跨时钟传输路径不会分析

7. 约束互斥时钟：五里互斥（输入给FPGA的时钟clk1、clk2不同时有效，FPGA外部物理芯片控制的）、逻辑互斥（选择器对两个时钟进行选择输出）

8. 假路径约束：（什么是伪路径？伪路径指的是该路径存在，但该路径的电路功能不会发生或者无需时序约束。如果路径上的电路不会发生，那Vivado综合后会自动优化掉，因此我们无需考虑这种情况。），异步时钟之间的路径都是假路径

9. 多周期约束：

10. [Vivado](https://so.csdn.net/so/search?q=Vivado&spm=1001.2101.3001.7020)、TimeQuest等时序引擎默认是按照单周期关系分析数据关系的，即数据在发起沿发送，在捕获被捕获，发起沿和捕获沿相差一个周期。

    但是很多情况是，数据路径逻辑较为复杂，导致延时较大，使得数据无法在一个时钟周期内稳定下来， 或者数据可以在一个时钟周期内稳定下来，但是在数据发送几个周期之后才使用；在这些情况中，设计者的意图都是使数据的有效期从发起沿为起始直至数个周期之后的捕获沿，这样的意图无法被时序分析工具猜度出来，必须由设计者在[时序约束](https://so.csdn.net/so/search?q=时序约束&spm=1001.2101.3001.7020)中指明；否则时序分析工具会按照单周期路径检查的方式执行，往往会误报出时序违规；

    **说白了，就是根据用于设计需求，改变原有的时序检查机制，从而避免非真实的时序违例或者时序过紧导致的资源浪费。**

---

带锁的都是IP核自动约束的



寄存器赋值延时一拍，采集外部输入信号时除外。
